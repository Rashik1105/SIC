{% extends "sic/base.html" %}
{% block content %}
<h2>Chat with {{ message_to }}</h2>

<div id="chat-messages">
    {% for message in messages %}
        <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
            <p>{{ message.get_message }}</p>
            <small>{{ message.timestamp|date:"H:i A" }}</small>
        </div>
    {% endfor %}
</div>

<div class="chat-input-container">
    <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
    <button onclick="sendMessage()">Send</button>
</div>

<script>
const chatSocket = new WebSocket(
    "wss://" + "maglev.proxy.rlwy.net:16705" + "/ws/chat/{{ chat_room.id }}/"
);


// ðŸ“Œ Receive WebSocket Messages & Display
chatSocket.onmessage = function(event) {
    let data = JSON.parse(event.data);
    let messageContainer = document.getElementById("chat-messages");

    let newMessage = document.createElement("div");
    newMessage.classList.add("message");
    newMessage.classList.add(data.sender === "{{ request.user.username }}" ? "sent" : "received");
    newMessage.innerHTML = `<p>${data.message}</p><small>${new Date().toLocaleTimeString()}</small>`;

    messageContainer.appendChild(newMessage);
    messageContainer.scrollTop = messageContainer.scrollHeight; // Auto-scroll to latest message
};

// ðŸ“Œ Send Message to WebSocket
function sendMessage() {
    let inputField = document.getElementById("messageInput");
    let message = inputField.value.trim();

    if (message) {
        chatSocket.send(JSON.stringify({"message": message, "sender": "{{ request.user.username }}"}));
        inputField.value = "";
    }
}

// ðŸ“Œ Handle "Enter" Key Press
function handleKeyPress(event) {
    if (event.key === "Enter") sendMessage();
}

</script>

<style>
    #chat-messages {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .message {
        padding: 10px;
        border-radius: 10px;
        margin: 5px 0;
        max-width: 75%;
        word-wrap: break-word;
    }

    .sent {
        background-color: #0d6efd;
        color: white;
        text-align: right;
        margin-left: auto;
    }

    .received {
        background-color: #e9ecef;
        color: black;
        text-align: left;
        margin-right: auto;
    }

    .chat-input-container {
        display: flex;
        margin-top: 10px;
    }

    .chat-input-container input {
        flex: 1;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
        font-size: 16px;
    }

    .chat-input-container button {
        background: #28a745;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 5px;
    }

    .chat-input-container button:hover {
        background: #218838;
    }
</style>

{% endblock %}
